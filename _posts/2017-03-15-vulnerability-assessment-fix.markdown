---
layout     : post
title      : "Vulnerability assessment & fix"
subtitle   : ""
date       : 2017-03-15
author     : "Shihta"
tags       : Security
comments   : true
---

# Introduction

有一部分解決網路安全的做法很簡單，只要設定web server多一些header就可以了，說明可以參考[這裡][1]，設定方法可以參考[這裡][2]

# Methods of Assessment

目前使用起來，有兩個站可以針對header掃瞄

- [securityheaders.io][3]
- [SSL LABS][4]

設定完全之後，結果應該要類似下圖：

![Result of securityheaders.io](/static/2017-03-15/result-of-securityheaders-io.png)

![Result of SSL LABS](/static/2017-03-15/result-of-ssl-labs.png)

# Apache Module mod_headers

由於要更改header，因此需要額外啟動這個module，細節可以參考[官方文件][5]

啟用的步驟寫在Dockerfile中，修改方法請參考之前的[文件][6]

# Security Headers

增加的設定如下

```ApacheConf
<IfModule mod_headers.c>
    Header set X-XSS-Protection "1; mode=block"
    Header set X-Frame-Options SAMEORIGIN env=!REDIRECT_IS_embed
    Header set X-Content-Type-Options nosniff
    Header set Content-Security-Policy "default-src 'self' https://*.amazonaws.com; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.mouseflow.com"
    Header set Strict-Transport-Security "max-age=15552000"
    Header edit Set-Cookie ^(.*)$ $1;HttpOnly;Secure
    Header unset "X-Powered-By"
    Header set Referrer-Policy "no-referrer"
    Header set Public-Key-Pins "pin-sha256=\"8hqbhsMMFPaPA8t81pxqFer9+neHBcQvO7+TAKjWkb0=\"; pin-sha256=\"JSMzqOOrtyOT1kmau6zKhgT676hGgczD5VMdRMyJZFA=\"; max-age=2592000; includeSubDomains"
</IfModule>
```

## HTTP Public Key Pinning

個人覺得比較複雜的是修改`Public-Key-Pins`，這個header的內容是網站安全憑證的Subject Public Key Information (SPKI) fingerprint，個人覺得[MDN][7]的說明寫得比較清楚

在省錢的原則下，我們通常都會用免費的安全憑證，例如[ACM][8]，因此可以參考下圖的點法，把中繼憑證匯出

![Result of SSL LABS](/static/2017-03-15/export-certificates.png)

另外所謂的`backup key`，指的是透過另一家簽發憑證的公司的中繼憑證，我們不一定有申請第二家憑證，所以省錢省事的方法，就是直接隨便找一個合法的中繼憑證，算出其fingerprint即可，以下是兩個憑證的算法：

```
$ cat Amazon.pem | openssl x509 -pubkey -noout | openssl rsa -pubin -outform der | openssl dgst -sha256 -binary | openssl enc -base64
writing RSA key
JSMzqOOrtyOT1kmau6zKhgT676hGgczD5VMdRMyJZFA=

$ cat TWCASecureSSLCertificationAuthority.cer | openssl x509 -pubkey -noout | openssl rsa -pubin -outform der | openssl dgst -sha256 -binary | openssl enc -base64
writing RSA key
8hqbhsMMFPaPA8t81pxqFer9+neHBcQvO7+TAKjWkb0=
```

<!-- Reference -->

[1]: http://devco.re/blog/2014/03/10/security-issues-of-http-headers-1/ "HTTP Headers 的資安議題 (1)"
[2]: https://hzsh.xyz/877/%E7%B6%B2%E7%AB%99http-headers%E9%85%8D%E7%BD%AE-%E5%BE%9E%E8%A8%AA%E5%AE%A2%E7%AB%AF%E6%8F%90%E5%8D%87%E7%AB%99%E9%BB%9E%E5%AE%89%E5%85%A8%E6%80%A7 "網站HTTP headers配置-從訪客端提升站點安全性"
[3]: https://securityheaders.io/ "securityheaders.io"
[4]: https://www.ssllabs.com/ssltest/index.html "SSL LABS - SSL Server Test"
[5]: https://httpd.apache.org/docs/current/mod/mod_headers.html "Apache Module mod_headers"
[6]: /2017/03/10/How-to-change-ap-config/ "How to change ap config"
[7]: https://developer.mozilla.org/en-US/docs/Web/HTTP/Public_Key_Pinning "HTTP Public Key Pinning (HPKP)"
[8]: https://aws.amazon.com/tw/certificate-manager/ "AWS Certificate Manager"
